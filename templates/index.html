<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copernicus Data Download</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .download-status { display: none; margin-top: 20px; }
        .download-status.show { display: block; }
        .progress-container { display: none; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Copernicus 数据下载系统</h1>
        
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <form id="downloadForm" method="POST">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="product_type" class="form-label">产品类型</label>
                            <select id="product_type" name="product_type" class="form-select" required>
                                <option value="reanalysis">Reanalysis</option>
                                <option value="ensemble_members">Ensemble Members</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="variable" class="form-label">变量</label>
                            <select id="variable" name="variable" class="form-select" multiple required>
                                <option value="geopotential">Geopotential</option>
                                <option value="temperature">Temperature</option>
                                <option value="u_component_of_wind">U Component of Wind</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="pressure_level" class="form-label">压力层</label>
                            <select id="pressure_level" name="pressure_level" class="form-select" required>
                                <option value="1000">1000 hPa</option>
                                <option value="850">850 hPa</option>
                                <option value="500">500 hPa</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="year" class="form-label">年份</label>
                            <select id="year" name="year" class="form-select" required></select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="month" class="form-label">月份</label>
                            <select id="month" name="month" class="form-select" required>
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="day" class="form-label">日期</label>
                            <select id="day" name="day" class="form-select" required></select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="time" class="form-label">时间</label>
                            <select id="time" name="time" class="form-select" required></select>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg">开始下载</button>
                    </div>
                </form>

                <div class="progress-container" id="progressContainer">
                    <div class="text-center mb-3">
                        <h5>正在下载数据...</h5>
                        <p class="text-muted">请耐心等待</p>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                </div>

                <div class="download-status" id="downloadStatus">
                    <div class="alert alert-success">
                        <h4>下载完成！</h4>
                        <p>您的数据已准备就绪</p>
                        <div class="mt-3">
                            <p><strong>文件名:</strong> <span id="fileName">-</span></p>
                            <p><strong>文件大小:</strong> <span id="fileSize">-</span></p>
                            <p><strong>过期时间:</strong> <span id="expiryTime">-</span></p>
                        </div>
                        <a href="#" class="btn btn-success" id="downloadLink" target="_blank">
                            下载文件
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            initializeFormOptions();
            document.getElementById('downloadForm').addEventListener('submit', handleFormSubmit);
        });

        function initializeFormOptions() {
            var startYear = 1940;
            var endYear = new Date().getFullYear();
            var yearSelect = document.getElementById('year');

            for (var year = startYear; year <= endYear; year++) {
                var option = new Option(year, year, year === endYear, year === endYear);
                yearSelect.add(option);
            }

            var daySelect = document.getElementById('day');
            for (var day = 1; day <= 31; day++) {
                var dayValue = day < 10 ? '0' + day : day.toString();
                var option = new Option(dayValue, dayValue);
                daySelect.add(option);
            }

            var timeSelect = document.getElementById('time');
            for (var hour = 0; hour < 24; hour++) {
                var timeValue = (hour < 10 ? '0' : '') + hour + ':00';
                var option = new Option(timeValue, timeValue);
                timeSelect.add(option);
            }
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            showProgress();
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showDownloadStatus(result);
                } else {
                    alert('下载失败: ' + result.message);
                }
            } catch (error) {
                alert('网络错误，请稍后重试');
            } finally {
                hideProgress();
            }
        }

        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('downloadStatus').classList.remove('show');
            
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
                
                if (progress >= 90) {
                    clearInterval(interval);
                }
            }, 500);
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        function showDownloadStatus(result) {
            document.getElementById('fileName').textContent = result.filename;
            document.getElementById('fileSize').textContent = result.file_size_mb + ' MB';
            document.getElementById('expiryTime').textContent = result.expiry_hours + ' 小时';
            
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = result.download_url;
            
            document.getElementById('downloadStatus').classList.add('show');
        }
    </script>
</body>
</html> 
